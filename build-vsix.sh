#!/bin/bash

# build-vsix.sh - –°–∫—Ä–∏–ø—Ç –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è Continue VS Code –≤ VSIX —Ñ–∞–π–ª
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./build-vsix.sh

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ü–≤–µ—Ç–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
if [ ! -f "package.json" ] || [ ! -d "extensions/vscode" ]; then
    print_error "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ Continue"
    exit 1
fi

print_status "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∫–æ–º–ø–∏–ª—è—Ü–∏—é —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è Continue VS Code..."

# –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
print_status "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."
npm install || {
    print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
    exit 1
}
print_success "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ core
print_status "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ core..."
cd core
npm install || {
    print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ core"
    exit 1
}
cd ..
print_success "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ core —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ gui
print_status "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ gui..."
cd gui
npm install || {
    print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ gui"
    exit 1
}

# –®–∞–≥ 4: –°–±–æ—Ä–∫–∞ GUI
print_status "üî® –°–±–æ—Ä–∫–∞ GUI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞..."
npm run build || {
    print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ GUI"
    exit 1
}
cd ..
print_success "GUI —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ"

# –®–∞–≥ 5: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏ VS Code
print_status "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏ VS Code..."
cd extensions/vscode
npm install || {
    print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏ VS Code"
    exit 1
}
print_success "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏ VS Code —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# –®–∞–≥ 6: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ GUI –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
print_status "üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ GUI –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ..."
rm -rf gui
cp -r ../../gui/dist gui || {
    print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ GUI"
    exit 1
}
print_success "GUI —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ"

# –®–∞–≥ 7: –°–±–æ—Ä–∫–∞ TypeScript –∫–æ–¥–∞
print_status "üî® –°–±–æ—Ä–∫–∞ TypeScript –∫–æ–¥–∞..."
npm run esbuild || {
    print_warning "esbuild –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."
}
print_success "TypeScript –∫–æ–¥ —Å–æ–±—Ä–∞–Ω"

# –®–∞–≥ 8: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ build
print_status "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ build..."
mkdir -p build

# –®–∞–≥ 9: –£–ø–∞–∫–æ–≤–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤ VSIX
print_status "üì¶ –£–ø–∞–∫–æ–≤–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤ VSIX —Ñ–∞–π–ª..."
npm run package || {
    print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–ø–∞–∫–æ–≤–∫–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è"
    exit 1
}

# –®–∞–≥ 10: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
if [ -f build/continue-*.vsix ]; then
    VSIX_FILE=$(ls build/continue-*.vsix)
    VSIX_SIZE=$(ls -lh "$VSIX_FILE" | awk '{print $5}')
    print_success "üéâ VSIX —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
    echo ""
    echo "üìÑ –§–∞–π–ª: $VSIX_FILE"
    echo "üìè –†–∞–∑–º–µ—Ä: $VSIX_SIZE"
    echo ""
    echo "üöÄ –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤ VS Code –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
    echo "   code --install-extension $VSIX_FILE"
    echo ""
    echo "   –ò–ª–∏ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å VS Code:"
    echo "   Extensions ‚Üí Install from VSIX ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª"
else
    print_error "VSIX —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

print_success "‚úÖ –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!" 